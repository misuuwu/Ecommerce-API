<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DigiSoria</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        // *** Updated Tailwind Config for a Light/Bright eCommerce Theme ***
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        // Light/Bright Theme Colors
                        'primary-blue': '#1F46A9', // Darker blue for main elements/buttons
                        'secondary-gray': '#F9FAFB', // Very light background
                        'accent-orange': '#FF6B1F', // Bright orange for accents (for Checkout button)
                        'text-dark': '#1F2937', // Dark text
                        'text-muted': '#6B7280', // Muted text/descriptions
                        'red-danger': '#EF4444',
                        'light-bg': '#FFFFFF', // White for cards and navigation
                        'page-bg': '#F3F4F6', // Light gray for the overall page background
                    },
                    boxShadow: {
                        'custom-light': '0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06)',
                    }
                }
            }
        }
    </script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        .bouncing {
            animation: bounce 0.6s cubic-bezier(0.68, -0.55, 0.27, 1.55) both;
        }

        @keyframes bounce {
            0% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.2);
            }

            100% {
                transform: scale(1);
            }
        }

        .product-card {
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
            transition: all 0.3s ease;
        }

        .product-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }

        /* Styling for the user profile dropdown menu */
        .profile-menu {
            display: none;
        }

        .profile-menu.open {
            display: block;
        }

        /* Carousel Indicator Active State */
        .carousel-indicator.active {
            background-color: '#FF6B1F';
            /* accent-orange */
            width: 1rem;
            opacity: 1;
        }

        /* Shopping Cart Drawer Styles */
        #cart-drawer {
            position: fixed;
            top: 0;
            right: 0;
            width: 100%;
            max-width: 420px;
            /* Wider than usual for product detail */
            height: 100%;
            background-color: #F9FAFB;
            /* secondary-gray */
            box-shadow: -4px 0 12px rgba(0, 0, 0, 0.15);
            transform: translateX(100%);
            transition: transform 0.3s ease-in-out;
            z-index: 50;
            /* Higher than header */
            display: flex;
            flex-direction: column;
        }

        #cart-drawer.open {
            transform: translateX(0);
        }

        /* Backdrop overlay */
        #cart-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 40;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease-in-out;
        }

        #cart-backdrop.open {
            opacity: 1;
            pointer-events: auto;
        }

        /* Order Review Screen Styles */
        #order-review-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #F3F4F6;
            /* page-bg */
            z-index: 60;
            transform: translateX(100%);
            transition: transform 0.3s ease-in-out;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }

        #order-review-screen.open {
            transform: translateX(0);
        }

        /* Track Order Screen Styles */
        #track-order-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #F3F4F6;
            /* page-bg */
            z-index: 70;
            /* Above review screen */
            transform: translateY(100%);
            transition: transform 0.3s ease-in-out;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }

        #track-order-screen.open {
            transform: translateY(0);
        }

        /* Progress Bar Styling */
        .progress-step {
            position: relative;
            z-index: 2;
            text-align: center;
        }

        .progress-bar-line {
            position: absolute;
            top: 20px;
            /* Aligns with the middle of the circles */
            left: 0;
            right: 0;
            height: 4px;
            background-color: #D1D5DB;
            /* Gray */
            z-index: 1;
        }

        .progress-fill {
            height: 100%;
            background-color: #FF6B1F;
            /* Accent Orange */
            transition: width 0.5s ease-in-out;
        }

        .step-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: #D1D5DB;
            /* Default gray */
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 8px;
            transition: background-color 0.3s ease;
        }

        .step-icon.active {
            background-color: #FF6B1F;
            /* Accent Orange */
            box-shadow: 0 0 0 4px rgba(255, 107, 31, 0.3);
        }

        .step-icon i {
            color: white;
            transition: color 0.3s ease;
        }
    </style>
</head>

<body class="bg-page-bg font-sans antialiased text-text-dark">

    <header class="bg-primary-blue shadow-md sticky top-0 z-20">
        <div class="container mx-auto py-4 px-0 md:px-4 flex justify-between items-center">

            <div class="flex items-center space-x-4 pl-4 md:pl-0">
                <button class="text-white hover:text-accent-orange transition-colors">
                    <i class="fas fa-bars text-xl"></i>
                </button>
                <a href="index.html" class="text-2xl font-bold text-white hidden sm:block">DigiSoria</a>
            </div>

            <div class="flex flex-grow max-w-lg mx-2 md:mx-8">
                <div class="relative w-full">
                    <input type="search" placeholder="Search for products..."
                        class="w-full p-2 pl-10 border border-gray-300 rounded-lg text-text-dark focus:ring-accent-orange focus:border-accent-orange">
                    <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                </div>
            </div>

            <div class="flex items-center space-x-6 ml-4 pr-4 md:pr-0">

                <div id="user-indicator"
                    class="text-xs font-medium text-white px-3 py-1 rounded-full bg-white/20 hidden md:block transition-colors duration-200">
                    Logged Out
                </div>

                <button class="text-white hover:text-red-danger transition-colors hidden md:block">
                    <i class="fas fa-heart text-xl"></i>
                </button>

                <button id="cart-button" class="relative text-white hover:text-accent-orange transition-colors">
                    <i class="fas fa-shopping-cart text-xl"></i>
                    <span id="cart-count"
                        class="absolute -top-1 -right-1 bg-red-danger text-white text-xs font-bold rounded-full h-4 w-4 flex items-center justify-center">0</span>
                </button>

                <div class="relative" id="profile-container">
                    <button class="text-white hover:text-accent-orange transition-colors" id="profile-button">
                        <i class="fas fa-user-circle text-xl"></i>
                    </button>

                    <div id="profile-menu"
                        class="profile-menu absolute right-0 mt-3 w-48 bg-white rounded-lg shadow-xl py-2 z-20 transition-all duration-150 ease-in-out border border-gray-100">
                        <div
                            class="absolute right-3 -top-2 w-0 h-0 border-l-8 border-l-transparent border-r-8 border-r-transparent border-b-8 border-b-white">
                        </div>
                        <a href="profile.html" class="block px-4 py-2 text-text-dark hover:bg-gray-100 font-medium">My Profile</a>
                        <a href="#" class="block px-4 py-2 text-text-dark hover:bg-gray-100">Order History</a>
                        <a href="sellerpage.html" class="block px-4 py-2 text-text-dark hover:bg-gray-100 border-t mt-1 pt-2">Start
                            Selling</a>
                        <a href="login.html" id="auth-toggle-btn" class="block px-4 py-2 text-red-danger hover:bg-gray-100">
                            <span id="auth-button-text">Log In / Sign Out</span>
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </header>
    <div class="container mx-auto px-4 md:px-8 pt-4 md:pt-8">

        <section class="relative bg-light-bg rounded-xl overflow-hidden shadow-lg mb-8 h-80 overflow-x-hidden">
            <div id="carousel-slides" class="flex h-full transition-transform duration-500 ease-in-out">
                <div
                    class="flex-shrink-0 w-full bg-accent-orange text-white p-8 md:p-16 flex flex-col justify-center items-center text-center">
                    <h1 class="text-3xl md:text-5xl font-extrabold mb-4">Flash Sale!</h1>
                    <p class="text-md md:text-lg max-w-2xl mx-auto">Up to 50% off on selected items! Don't miss out.</p>
                </div>
                <div
                    class="flex-shrink-0 w-full bg-primary-blue text-white p-8 md:p-16 flex flex-col justify-center items-center text-center">
                    <h1 class="text-3xl md:text-5xl font-extrabold mb-4">New Arrivals!</h1>
                    <p class="text-md md:text-lg max-w-2xl mx-auto">Check out the latest tech and gadgets added this week!</p>
                </div>
                <div
                    class="flex-shrink-0 w-full bg-secondary-gray text-text-dark p-8 md:p-16 flex flex-col justify-center items-center text-center">
                    <h1 class="text-3xl md:text-5xl font-extrabold mb-4">Free Shipping!</h1>
                    <p class="text-md md:text-lg max-w-2xl mx-auto">On all orders over $50. Limited time offer.</p>
                </div>
            </div>

            <button id="prev-slide"
                class="absolute top-1/2 left-4 transform -translate-y-1/2 text-white text-3xl p-2 rounded-full bg-black bg-opacity-30 hover:bg-opacity-50 transition-opacity cursor-pointer z-10">
                <i class="fas fa-chevron-left"></i>
            </button>
            <button id="next-slide"
                class="absolute top-1/2 right-4 transform -translate-y-1/2 text-white text-3xl p-2 rounded-full bg-black bg-opacity-30 hover:bg-opacity-50 transition-opacity cursor-pointer z-10">
                <i class="fas fa-chevron-right"></i>
            </button>

            <div class="absolute bottom-4 left-1/2 transform -translate-x-1/2 flex space-x-2 z-10">
                <span
                    class="w-2 h-2 bg-white rounded-full bg-opacity-70 carousel-indicator transition-all duration-300"></span>
                <span
                    class="w-2 h-2 bg-white rounded-full bg-opacity-70 carousel-indicator transition-all duration-300"></span>
                <span
                    class="w-2 h-2 bg-white rounded-full bg-opacity-70 carousel-indicator transition-all duration-300"></span>
            </div>
        </section>

        <section class="mb-8">
            <h2 class="text-2xl font-bold text-text-dark mb-4">Product Categories</h2>
            <div class="flex flex-wrap gap-3">
                <button
                    class="px-4 py-2 bg-white text-primary-blue border border-primary-blue rounded-full shadow-sm hover:bg-primary-blue hover:text-white transition-colors font-medium">All</button>
                <button
                    class="px-4 py-2 bg-white text-text-dark border border-gray-300 rounded-full shadow-sm hover:bg-gray-100 transition-colors font-medium">Electronics</button>
                <button
                    class="px-4 py-2 bg-white text-text-dark border border-gray-300 rounded-full shadow-sm hover:bg-gray-100 transition-colors font-medium">Appliances</button>
                <button
                    class="px-4 py-2 bg-white text-text-dark border border-gray-300 rounded-full shadow-sm hover:bg-gray-100 transition-colors font-medium">Outdoor</button>
                <button
                    class="px-4 py-2 bg-white text-text-dark border border-gray-300 rounded-full shadow-sm hover:bg-gray-100 transition-colors font-medium">Accessories</button>
                <button
                    class="px-4 py-2 bg-white text-text-dark border border-gray-300 rounded-full shadow-sm hover:bg-gray-100 transition-colors font-medium">Smart Home</button>
                <button
                    class="px-4 py-2 bg-white text-text-dark border border-gray-300 rounded-full shadow-sm hover:bg-gray-100 transition-colors font-medium">Fitness</button>
            </div>
        </section>

        <section>
            <h2 class="text-2xl font-bold text-text-dark mb-4">Featured Products</h2>
            <div id="featured-products-grid"
                class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-6">
                <div class="bg-white rounded-xl shadow-lg overflow-hidden product-card animate-pulse">
                    <div class="w-full h-48 bg-gray-200"></div>
                    <div class="p-4">
                        <div class="h-6 bg-gray-200 rounded w-3/4 mb-2"></div>
                        <div class="h-4 bg-gray-200 rounded w-1/2 mb-2"></div>
                        <div class="h-4 bg-gray-200 rounded w-full mb-2"></div>
                        <div class="h-6 bg-gray-200 rounded w-1/4"></div>
                    </div>
                </div>
            </div>
        </section>

        <footer class="mt-12 text-center text-text-muted text-sm border-t pt-4">
            <p>&copy; 2024 DigiSoria. All rights reserved.</p>
        </footer>
    </div>

    <div id="cart-backdrop"></div>

    <div id="cart-drawer">
        <div class="p-5 border-b flex justify-between items-center bg-white shadow-sm">
            <h3 class="text-2xl font-bold text-primary-blue">Your Shopping Cart</h3>
            <button id="close-cart-btn" class="text-text-muted hover:text-red-danger transition-colors text-2xl">
                <i class="fas fa-times"></i>
            </button>
        </div>

        <div id="cart-items-list" class="flex-grow overflow-y-auto p-4 space-y-4">
        </div>

        <div class="p-4 bg-white border-t-2 border-accent-orange/50 shadow-2xl">
            <div class="flex justify-between items-center mb-4">
                <label class="flex items-center text-sm font-medium text-text-dark">
                    <input type="checkbox" id="select-all-checkbox"
                        class="h-4 w-4 text-primary-blue rounded focus:ring-primary-blue border-gray-300 mr-2">
                    Select All (<span id="selected-item-count">0</span>)
                </label>
                <div class="text-md font-medium">
                    Total Item: <span class="text-2xl font-bold text-red-danger">$<span
                            id="cart-total">0.00</span></span>
                </div>
            </div>

            <button id="checkout-button"
                class="w-full py-3 bg-accent-orange text-white font-extrabold text-lg rounded-xl shadow-lg hover:bg-orange-600 transition-colors transform hover:scale-[1.01] active:scale-[0.99] disabled:opacity-50"
                disabled>
                Check Out
            </button>
        </div>
    </div>
    <div id="order-review-screen">
    </div>
    <div id="track-order-screen">
    </div>
    <script type="module">
        import {
            initializeApp
        } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
        // Import Firebase Auth functions
        import {
            getAuth,
            onAuthStateChanged,
            signOut,
        } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-auth.js";
        import {
            getFirestore,
            collection,
            query,
            onSnapshot,
            // Imports for Cart Persistence
            doc,
            setDoc,
            getDoc,
            // End Imports
            updateDoc,
            increment,
            setLogLevel
        } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";

        // Firebase global variables provided by the environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = {
            apiKey: "AIzaSyAqDLocdi1CDHDeD5Z_LOlVZOycI2tuJpk",
            authDomain: "digisoria-baa83.firebaseapp.com",
            projectId: "digisoria-baa83",
            storageBucket: "digisoria-baa83.appspot.com",
            messagingSenderId: "1042609120554",
            appId: "1:1042609120554:web:0500a100e9ae42ead32a53",
            measurementId: "G-TM8CBPSRR9"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app); // Initialize Firebase Auth

        // ===================================
        // METRICS/ANALYTICS LOGIC
        // ===================================

        const METRICS_COLLECTION = 'metrics';
        const METRICS_DOC_ID = 'funnel_counts';
        let CURRENT_USER_ID = 'not-authenticated-user-placeholder';
        // <<< CORE FIX: New flag to ensure cart operations wait for authentication status
        let isAuthResolved = false;

        /**
         * Atomically increments a specified metric field in the Firestore for the current user.
         */
        const updateUserMetric = async (fieldName) => {
            if (CURRENT_USER_ID === 'not-authenticated-user-placeholder') {
                console.warn(`User is not authenticated. Cannot track metric: ${fieldName}.`);
                alert('Login Required', 'Please log in to track your order activity.', 'info');
                return;
            }
            const metricsRef = doc(db, 'users', CURRENT_USER_ID, METRICS_COLLECTION, METRICS_DOC_ID);
            try {
                await setDoc(metricsRef, {
                    [fieldName]: increment(1),
                    lastUpdated: new Date().toISOString()
                }, {
                    merge: true
                });
                console.log(`User metric updated: ${fieldName} for user: ${CURRENT_USER_ID}.`);
            } catch (e) {
                console.error(`Error updating user metric ${fieldName}:`, e);
            }
        };

        // ===================================
        // CART PERSISTENCE LOGIC (FIXED PROBLEM)
        // ===================================
        const CART_COLLECTION = 'carts';
        const CART_DOC_ID = 'currentCart';

        // ** Global Cart State **
        let cartItems = [];

        /**
         * Saves the current cartItems array to Firestore for the logged-in user.
         */
        const saveCartToFirestore = async () => {
             // <<< CORE FIX: Check if auth is resolved AND user is logged in
            if (!isAuthResolved || CURRENT_USER_ID === 'not-authenticated-user-placeholder') {
                console.warn("Authentication not resolved or user not logged in. Cannot save cart.");
                return;
            }

            // Path: users/{UID}/carts/currentCart
            const cartRef = doc(db, 'users', CURRENT_USER_ID, CART_COLLECTION, CART_DOC_ID);

            try {
                // Save the entire cartItems array
                await setDoc(cartRef, {
                    items: cartItems,
                    lastUpdated: new Date().toISOString()
                }, { merge: true }); // Use merge: true just in case
                console.log("Shopping cart saved to Firestore successfully.");
            } catch (e) {
                console.error("Error saving cart to Firestore:", e);
            }
        };

        /**
         * Loads the cartItems array from Firestore for the logged-in user.
         */
        const loadCartFromFirestore = async (userId) => {
            if (userId === 'not-authenticated-user-placeholder') {
                return [];
            }

            const cartRef = doc(db, 'users', userId, CART_COLLECTION, CART_DOC_ID);

            try {
                const docSnap = await getDoc(cartRef);
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    console.log("Shopping cart loaded from Firestore successfully. Items:", data.items ? data.items.length : 0);
                    return data.items || [];
                } else {
                    console.log("No existing cart found in Firestore. Starting with an empty cart.");
                    return [];
                }
            } catch (e) {
                console.error("Error loading cart from Firestore:", e);
                return []; // Fallback to empty cart on error
            }
        };


        // ===================================
        // AUTHENTICATION STATE MANAGEMENT - INTEGRATED WITH CART LOAD (FIXED)
        // ===================================

        const userIndicator = document.getElementById('user-indicator');
        const authButtonText = document.getElementById('auth-button-text');

        // ** Refactored onAuthStateChanged for synchronous cart state update **
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                // User is signed in.
                CURRENT_USER_ID = user.uid;

                const displayName = user.displayName || user.email;
                userIndicator.textContent = `Welcome, ${displayName.split('@')[0]}`;
                userIndicator.classList.remove('hidden', 'bg-white/20');
                userIndicator.classList.add('bg-accent-orange/80');
                authButtonText.textContent = "Sign Out";

                // Load cart and update global state after authentication
                cartItems = await loadCartFromFirestore(CURRENT_USER_ID);
                renderCart();

            } else {
                // User is signed out.
                CURRENT_USER_ID = 'not-authenticated-user-placeholder';
                userIndicator.textContent = 'Logged Out';
                userIndicator.classList.remove('hidden', 'bg-accent-orange/80');
                userIndicator.classList.add('bg-white/20');
                authButtonText.textContent = "Log In";

                // Clear cart immediately on sign out
                cartItems = [];
                renderCart();
            }

            // <<< CORE FIX: Set the flag AFTER we have determined the user status
            isAuthResolved = true;
        });


        // ===================================
        // CART STATE & LOGIC
        // ===================================
        const cartCountElement = document.getElementById('cart-count');
        const cartDrawer = document.getElementById('cart-drawer');
        const cartBackdrop = document.getElementById('cart-backdrop');
        const cartItemsList = document.getElementById('cart-items-list');
        const cartTotalElement = document.getElementById('cart-total');
        const selectedItemCountElement = document.getElementById('selected-item-count');
        const checkoutButton = document.getElementById('checkout-button');
        const selectAllCheckbox = document.getElementById('select-all-checkbox');

        const orderReviewScreen = document.getElementById('order-review-screen');
        const trackOrderScreen = document.getElementById('track-order-screen');
        const SHIPPING_SUBTOTAL = 4.99;

        const updateCartCountDisplay = () => {
            const totalCount = cartItems.reduce((sum, item) => sum + item.quantity, 0);
            if (cartCountElement) {
                cartCountElement.textContent = totalCount;
            }
        };

        const updateCartTotal = () => {
            let subtotal = 0;
            let selectedCount = 0;
            cartItems.forEach(item => {
                if (item.selected) {
                    subtotal += item.price * item.quantity;
                    selectedCount++;
                }
            });
            if (cartTotalElement) {
                cartTotalElement.textContent = subtotal.toFixed(2);
            }
            if (selectedItemCountElement) {
                selectedItemCountElement.textContent = selectedCount;
            }
            if (checkoutButton) {
                checkoutButton.disabled = selectedCount === 0;
            }
            if (selectAllCheckbox) {
                // Only check 'select all' if the cart isn't empty and all items are selected
                selectAllCheckbox.checked = cartItems.length > 0 && selectedCount === cartItems.length;
            }
        };

        const renderCart = () => {
            cartItemsList.innerHTML = '';
            if (cartItems.length === 0) {
                cartItemsList.innerHTML = '<p class="text-center text-text-muted py-8">Your cart is empty.</p>';
            } else {
                cartItems.forEach((item, index) => {
                    const itemElement = document.createElement('div');
                    itemElement.className = 'bg-white rounded-lg shadow-sm flex flex-col space-y-3';

                    // Shop Name Header Row
                    const shopHeader = document.createElement('div');
                    shopHeader.className =
                        'flex items-center p-3 border-b border-gray-100 bg-secondary-gray rounded-t-lg';
                    shopHeader.innerHTML = `
                        <label class="flex items-center w-full">
                            <input type="checkbox" data-index="${index}" class="item-select-checkbox h-4 w-4 text-primary-blue rounded focus:ring-primary-blue border-gray-300 mr-3" ${item.selected ? 'checked' : ''}>
                            <span class="font-semibold text-text-dark text-sm">Shop Name Placeholder</span>
                        </label>
                    `;
                    itemElement.appendChild(shopHeader);

                    // Item Detail Row
                    const itemDetail = document.createElement('div');
                    itemDetail.className = 'flex items-start justify-between space-x-2 p-3 pt-0';
                    itemDetail.innerHTML = `
                        <div class="flex items-start flex-shrink-0 w-1/2">
                            <img src="${item.image}" alt="${item.name}" class="w-16 h-16 object-cover rounded-md flex-shrink-0 mr-3 mt-1">
                            <div class="flex flex-col flex-grow min-w-0">
                                <span class="font-medium text-text-dark truncate">${item.name}</span>
                                <select class="mt-1 text-xs text-text-muted border-gray-200 rounded-md p-1 min-w-[5rem] max-w-full">
                                    <option>Variations: Default</option>
                                    <option>Variations: Option A</option>
                                </select>
                            </div>
                        </div>

                        <div class="flex flex-grow justify-end items-center text-sm space-x-2">

                            <div class="flex flex-col items-center pt-2 hidden lg:flex min-w-[4rem]">
                                <span class="text-text-muted text-xs">Unit Price</span>
                                <span class="font-semibold text-primary-blue text-sm">$${item.price.toFixed(2)}</span>
                            </div>

                            <div class="flex flex-col items-center pt-2 min-w-[5.5rem] flex-shrink-0">
                                <span class="text-text-muted text-xs">Qty</span>
                                <div class="flex items-center border border-gray-300 rounded-md mt-1">
                                    <button class="qty-btn text-text-dark hover:bg-gray-100 px-2 py-1 rounded-l-md" data-index="${index}" data-action="decrease"><i class="fas fa-minus text-xs"></i></button>
                                    <span class="px-2 font-medium text-sm">${item.quantity}</span>
                                    <button class="qty-btn text-text-dark hover:bg-gray-100 px-2 py-1 rounded-r-md" data-index="${index}" data-action="increase"><i class="fas fa-plus text-xs"></i></button>
                                </div>
                            </div>

                            <div class="flex flex-col items-center pt-2 min-w-[4.5rem] flex-shrink-0">
                                <span class="text-text-muted text-xs">Total</span>
                                <span class="font-bold text-red-danger text-lg">$${(item.price * item.quantity).toFixed(2)}</span>
                            </div>

                            <button
                                class="delete-item-btn text-text-muted hover:text-red-danger transition-colors ml-2 pt-2 flex-shrink-0"
                                data-index="${index}">
                                <i class="fas fa-trash-alt text-lg"></i>
                            </button>
                        </div>
                    `;
                    itemElement.appendChild(itemDetail);
                    cartItemsList.appendChild(itemElement);
                });
                attachCartEventListeners();
            }
            updateCartTotal();
            updateCartCountDisplay();
        };

        const attachCartEventListeners = () => {
            document.querySelectorAll('.qty-btn').forEach(button => {
                button.addEventListener('click', (event) => {
                    const index = parseInt(event.currentTarget.dataset.index);
                    const action = event.currentTarget.dataset.action;
                    updateQuantity(index, action);
                });
            });
            document.querySelectorAll('.delete-item-btn').forEach(button => {
                button.addEventListener('click', (event) => {
                    const index = parseInt(event.currentTarget.dataset.index);
                    deleteItem(index);
                });
            });
            document.querySelectorAll('.item-select-checkbox').forEach(checkbox => {
                checkbox.addEventListener('change', (event) => {
                    const index = parseInt(event.target.dataset.index);
                    cartItems[index].selected = event.target.checked;
                    updateCartTotal();
                    saveCartToFirestore();
                });
            });
        };

        const toggleCartDrawer = () => {
            cartDrawer.classList.toggle('open');
            cartBackdrop.classList.toggle('open');
            if (cartDrawer.classList.contains('open')) {
                renderCart();
            }
        };

        const updateQuantity = (index, action) => {
            // <<< CORE FIX: Gated function call
            if (!isAuthResolved) {
                 alert('Loading...', 'Please wait for the page to finish loading user data.', 'info');
                 return;
            }

            const item = cartItems[index];
            if (action === 'increase') {
                item.quantity++;
            } else if (action === 'decrease' && item.quantity > 1) {
                item.quantity--;
            } else if (action === 'decrease' && item.quantity === 1) {
                deleteItem(index);
                return;
            }
            renderCart();
            saveCartToFirestore();
        };

        const deleteItem = (index) => {
            // <<< CORE FIX: Gated function call
            if (!isAuthResolved) {
                 alert('Loading...', 'Please wait for the page to finish loading user data.', 'info');
                 return;
            }

            cartItems.splice(index, 1);
            renderCart();
            saveCartToFirestore();
        };

        const addToCart = (product) => {
            updateUserMetric('shoppingCartAdds');

            // <<< CORE FIX: Gated function call
            if (!isAuthResolved) {
                 alert('Loading...', 'Please wait for the page to finish loading user data.', 'info');
                 return;
            }

            if (CURRENT_USER_ID === 'not-authenticated-user-placeholder') {
                 // Prevent cart operations if not logged in
                alert('Login Required', 'Please log in to add items to your persistent cart.', 'error');
                return;
            }

            const existingItem = cartItems.find(item => item.name === product.name);

            if (existingItem) {
                existingItem.quantity++;
            } else {
                cartItems.push({
                    name: product.name,
                    price: product.price,
                    quantity: 1,
                    image: product.image,
                    selected: true,
                });
            }

            updateCartCountDisplay();
            if (cartCountElement) {
                cartCountElement.classList.add('bouncing');
                setTimeout(() => {
                    cartCountElement.classList.remove('bouncing');
                }, 600);
            }
            if (!cartDrawer.classList.contains('open')) {
                toggleCartDrawer();
            } else {
                renderCart();
            }
            saveCartToFirestore();
        };

        // ===================================
        // ORDER REVIEW & TRACK ORDER LOGIC
        // ===================================

        const closeOrderReview = () => {
            orderReviewScreen.classList.remove('open');
        };

        const closeTrackOrder = () => {
            trackOrderScreen.classList.remove('open');
            trackOrderScreen.innerHTML = '';
        }

        const renderTrackOrderScreen = () => {
            const orderDetails = {
                name: "Product Name Placeholder",
                variation: "Large, Platinum Pink",
                unitPrice: 150.00,
                quantity: 1,
                totalPrice: 249.00,
                currentStep: 1,
                steps: [{
                    icon: 'fas fa-shopping-cart',
                    label: 'Order Placed'
                }, {
                    icon: 'fas fa-box-open',
                    label: 'Packing Order'
                }, {
                    icon: 'fas fa-hands-helping',
                    label: 'Order Shipped'
                }, {
                    icon: 'fas fa-truck',
                    label: 'Out for Delivery'
                }, {
                    icon: 'fas fa-box',
                    label: 'Delivered'
                }]
            };
            const currencySymbol = '₱';
            const progressPercentage = ((orderDetails.currentStep - 1) / (orderDetails.steps.length - 1)) * 100;
            let stepsHtml = orderDetails.steps.map((step, index) => {
                const stepNumber = index + 1;
                const isActive = stepNumber <= orderDetails.currentStep;
                const iconClass = step.icon;
                return `
                    <div class="progress-step w-1/5">
                        <div class="step-icon ${isActive ? 'active' : ''}">
                            <i class="${iconClass} text-lg"></i>
                        </div>
                        <span class="text-xs font-semibold ${isActive ? 'text-text-dark' : 'text-text-muted'}">${step.label}</span>
                    </div>
                `;
            }).join('');
            const content = `
                <div class="max-w-4xl mx-auto p-4 md:p-8">
                    <div class="flex justify-between items-center mb-6 border-b pb-4 bg-page-bg sticky top-0 z-10">
                        <h2 class="text-3xl font-extrabold text-primary-blue">Track Your Order</h2>
                        <button id="close-track-btn" class="text-text-muted hover:text-red-danger transition-colors text-2xl">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>

                    <div class="bg-white rounded-xl shadow-lg p-6 mb-8 border border-gray-200">
                        <div class="relative flex justify-between items-start mb-12">
                            <div class="progress-bar-line">
                                <div class="progress-fill" style="width: ${progressPercentage}%;"></div>
                            </div>
                            ${stepsHtml}
                        </div>

                        <div class="flex flex-col sm:flex-row border-t border-gray-100 pt-6">
                            <div class="flex items-start w-full sm:w-2/3 mb-6 sm:mb-0">
                                <div class="w-24 h-24 bg-gray-300 rounded-md flex-shrink-0 mr-4">
                                    </div>
                                <div class="flex flex-col">
                                    <span class="text-xl font-bold text-text-dark">${orderDetails.name}</span>
                                    <span class="text-sm text-accent-orange mt-1">Variation: ${orderDetails.variation}</span>
                                </div>
                            </div>

                            <div class="w-full sm:w-1/3 flex flex-col space-y-2 text-sm text-right">
                                <div class="flex justify-between">
                                    <span class="text-text-muted">Unit Price:</span>
                                    <span class="font-medium">${currencySymbol}${orderDetails.unitPrice.toFixed(2)}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-text-muted">Quantity:</span>
                                    <span class="font-medium">${orderDetails.quantity}</span>
                                </div>
                                <div class="flex justify-between items-center pt-2 border-t border-gray-100">
                                    <span class="text-lg font-semibold">Total Price:</span>
                                    <span class="text-2xl font-extrabold text-red-danger">${currencySymbol}${orderDetails.totalPrice.toFixed(2)}</span>
                                </div>
                                <span class="text-sm font-bold text-green-600">Cash On Delivery</span>
                            </div>
                        </div>
                    </div>

                    <div class="flex justify-between items-center p-4">
                        <button onclick="window.location.reload()" class="px-6 py-3 bg-primary-blue text-white font-semibold rounded-xl shadow-md hover:bg-blue-800 transition-colors">
                            Back to Shopping
                        </button>
                        <button onclick="alert('Message feature not implemented')"
                            class="px-6 py-3 bg-white text-text-dark border border-gray-300 font-semibold rounded-xl shadow-sm hover:bg-gray-100 transition-colors">
                            Message Seller
                        </button>
                    </div>
                </div>
            `;
            trackOrderScreen.innerHTML = content;
            trackOrderScreen.classList.add('open');
            document.getElementById('close-track-btn').addEventListener('click', closeTrackOrder);
        };

        const placeOrder = () => {
            updateUserMetric('placeOrders');
            console.log("Order Placed!");

            // 1. Filter out purchased items
            cartItems = cartItems.filter(item => !item.selected);

            // 2. Save the new, smaller cart array to Firestore
            saveCartToFirestore();

            // 3. Update the displays
            updateCartCountDisplay();
            updateCartTotal();
            renderCart();

            // 4. Close the order review screen
            closeOrderReview();

            // 5. Show the NEW Track Order screen
            renderTrackOrderScreen();
        };

        const renderOrderItem = (item) => {
            const row = document.createElement('div');
            const itemTotal = (item.price * item.quantity);
            const currencySymbol = '₱';
            row.className = 'bg-white rounded-lg shadow-sm flex flex-col p-4 mb-4 border border-gray-200';
            row.innerHTML = `
                <div class="grid grid-cols-4 md:grid-cols-6 lg:grid-cols-10 gap-2 items-center text-text-dark">
                    <div class="col-span-4 md:col-span-3 lg:col-span-5 flex items-start">
                        <img src="${item.image}" alt="${item.name}" class="w-16 h-16 object-cover rounded-md flex-shrink-0 mr-4">
                        <div class="flex flex-col">
                            <span class="font-bold text-lg leading-tight">${item.name}</span>
                            <span class="text-accent-orange text-sm mt-1">Variation: Default</span>
                        </div>
                    </div>

                    <div class="col-span-2 md:col-span-1 lg:col-span-2 text-center text-sm hidden sm:block">
                        <span class="text-text-muted text-xs block lg:hidden">Unit Price</span>
                        <span class="font-medium text-primary-blue mt-1">${currencySymbol}${item.price.toFixed(2)}</span>
                    </div>

                    <div class="col-span-2 md:col-span-1 lg:col-span-1 text-center text-sm hidden sm:block">
                         <span class="text-text-muted text-xs block lg:hidden">Qty</span>
                        <span class="font-medium mt-1">${item.quantity}</span>
                    </div>

                    <div class="col-span-4 md:col-span-1 lg:col-span-2 text-right">
                        <span class="font-extrabold text-red-danger text-xl">${currencySymbol}${itemTotal.toFixed(2)}</span>
                    </div>

                    <div class="col-span-4 sm:hidden flex flex-col text-sm text-text-muted mt-2">
                        <span>Unit: ${currencySymbol}${item.price.toFixed(2)} | Qty: ${item.quantity}</span>
                    </div>
                </div>
            `;
            return row;
        };


        const openOrderReview = () => {
            const selectedItems = cartItems.filter(item => item.selected);
            if (selectedItems.length === 0) {
                alert('No Items Selected', 'Please select at least one item to proceed to checkout.', 'error');
                return;
            }

            if (CURRENT_USER_ID === 'not-authenticated-user-placeholder') {
                 // Essential check for placing an order
                alert('Login Required', 'You must be logged in to proceed with checkout and order placement.', 'error');
                return;
            }

            updateUserMetric('checkouts');
            cartDrawer.classList.remove('open');
            cartBackdrop.classList.remove('open');

            let merchandiseSubtotal = selectedItems.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            const totalPayment = merchandiseSubtotal + SHIPPING_SUBTOTAL;
            const currencySymbol = '₱';

            const content = `
                <div class="max-w-4xl mx-auto p-4 md:p-8">
                    <div class="flex justify-between items-center mb-6 border-b pb-4 bg-page-bg sticky top-0 z-10">
                        <h2 class="text-3xl font-extrabold text-primary-blue">Review & Place Order</h2>
                        <button id="close-order-btn" class="text-text-muted hover:text-red-danger transition-colors text-2xl">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>

                    <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
                        <div class="flex justify-between items-center border-b pb-3 mb-3">
                            <div class="text-lg font-bold text-accent-orange flex items-center">
                                <i class="fas fa-map-marker-alt mr-2"></i>Delivery Address
                            </div>
                            <button class="text-primary-blue hover:text-accent-orange font-medium text-sm transition-colors">
                                Change Address
                            </button>
                        </div>
                        <p class="text-text-dark font-medium">John Doe</p>
                        <p class="text-text-muted text-sm">123 Main St, Apt 4B, Springfield, MA 01104, USA</p>
                        <p class="text-text-muted text-sm">(+1) 555-1234</p>
                    </div>

                    <h3 class="text-xl font-bold text-text-dark mb-4">Your Order(s):</h3>

                    <div class="hidden lg:grid grid-cols-10 gap-2 font-semibold text-text-muted text-sm border-b pb-2 px-4 mb-2">
                        <span class="col-span-5">Product Details</span>
                        <span class="col-span-2 text-center">Unit Price</span>
                        <span class="col-span-1 text-center">Quantity</span>
                        <span class="col-span-2 text-right">Total Price</span>
                    </div>

                    <div id="order-items-list" class="mb-8">
                        </div>

                    <div class="bg-white rounded-xl shadow-lg p-6 mb-8 flex flex-col lg:flex-row justify-between">

                        <div class="w-full lg:w-1/3 mb-6 lg:mb-0">
                            <h3 class="text-2xl font-bold text-text-dark mb-4">Payment Method</h3>
                            <div class="flex space-x-2">
                                <button class="px-4 py-2 bg-accent-orange text-white font-semibold rounded-lg shadow-md flex items-center">
                                    <i class="fas fa-truck mr-2"></i> Cash On Delivery
                                </button>
                                <button class="px-4 py-2 bg-green-500/80 text-white font-semibold rounded-lg shadow-md hover:bg-green-600 transition-colors">
                                    Discount %
                                </button>
                            </div>
                        </div>

                        <div class="w-full lg:w-1/2 flex flex-col items-end">
                            <div class="w-full max-w-sm space-y-2 text-text-dark mb-6">
                                <div class="flex justify-between">
                                    <span class="text-text-muted">Merchandise Subtotal:</span>
                                    <span class="font-medium">${currencySymbol}<span id="merchandise-subtotal">${merchandiseSubtotal.toFixed(2)}</span></span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-text-muted">Shipping Subtotal:</span>
                                    <span class="font-medium">${currencySymbol}${SHIPPING_SUBTOTAL.toFixed(2)}</span>
                                </div>
                                <div class="flex justify-between items-center pt-2 border-t border-gray-200">
                                    <span class="text-lg font-semibold">Total Payment:</span>
                                    <span class="text-3xl font-extrabold text-red-danger">${currencySymbol}<span id="total-payment">${totalPayment.toFixed(2)}</span></span>
                                </div>
                            </div>

                            <button id="place-order-btn"
                                class="w-full max-w-sm py-3 bg-accent-orange text-white font-extrabold text-lg rounded-xl shadow-xl hover:bg-orange-600 transition-colors transform hover:scale-[1.01] active:scale-[0.99]">
                                PLACE ORDER
                            </button>
                        </div>
                    </div>
                </div>
            `;
            orderReviewScreen.innerHTML = content;
            const orderItemsList = document.getElementById('order-items-list');
            selectedItems.forEach(item => {
                orderItemsList.appendChild(renderOrderItem(item));
            });
            document.getElementById('close-order-btn').addEventListener('click', closeOrderReview);
            document.getElementById('place-order-btn').addEventListener('click', placeOrder);

            orderReviewScreen.classList.add('open');
        };

        const getRatingStars = (rating) => {
            const fullStars = Math.floor(rating);
            const halfStar = rating % 1 !== 0;
            const emptyStars = 5 - fullStars - (halfStar ? 1 : 0);

            let starsHtml = '';
            for (let i = 0; i < fullStars; i++) {
                starsHtml += `<i class="fas fa-star"></i>`;
            }
            if (halfStar) {
                starsHtml += `<i class="fas fa-star-half-alt"></i>`;
            }
            for (let i = 0; i < emptyStars; i++) {
                starsHtml += `<i class="far fa-star"></i>`;
            }
            return starsHtml;
        };

        const featuredProductsGrid = document.getElementById('featured-products-grid');

        function renderProductCard(product) {
            const card = document.createElement('div');
            card.className =
                'bg-light-bg rounded-xl shadow-lg overflow-hidden product-card hover:shadow-xl transition-shadow duration-300 cursor-pointer flex flex-col justify-between';

            const price = parseFloat(product.price || 0).toFixed(2);
            const rating = parseFloat(product.rating || 0).toFixed(1);
            const description = product.description || 'No description provided.';
            const image = product.image || 'https://placehold.co/400x300/e2e8f0/64748b?text=No+Image';

            card.innerHTML = `
                <div>
                    <img src="${image}" alt="${product.name}" class="w-full h-48 object-cover">
                    <div class="p-4">
                        <h3 class="text-lg font-bold text-text-dark truncate">${product.name}</h3>
                        <div class="flex items-center text-amber-500 text-sm mb-1">
                            ${getRatingStars(product.rating || 0)}
                            <span class="ml-2 text-text-muted text-xs">(${rating})</span>
                        </div>
                        <p class="text-text-muted text-sm truncate">${description}</p>
                        <p class="text-xl font-bold text-primary-blue mt-2">$${price}</p>
                    </div>
                </div>
                <div class="p-4 pt-0">
                    <button class="add-to-cart-btn w-full px-4 py-2 bg-accent-orange text-white font-semibold rounded-lg shadow-md hover:bg-orange-600 transition-colors flex items-center justify-center space-x-2">
                        <i class="fas fa-cart-plus"></i>
                        <span>Add to cart</span>
                    </button>
                </div>
            `;

            const addToCartButton = card.querySelector('.add-to-cart-btn');
            if (addToCartButton) {
                addToCartButton.addEventListener('click', (event) => {
                    event.stopPropagation();
                    addToCart({
                        id: product.id || product.name,
                        name: product.name,
                        price: parseFloat(price),
                        image: image
                    });
                });
            }

            featuredProductsGrid.appendChild(card);
        }

        // --- Main Event Listener for DOM Ready ---
        document.addEventListener('DOMContentLoaded', () => {
            // ... (Carousel, Profile dropdown, Cart drawer listeners remain the same)
            const slides = document.getElementById('carousel-slides');
            const indicators = document.querySelectorAll('.carousel-indicator');
            let currentIndex = 0;
            const totalSlides = slides ? slides.children.length : 0;

            if (slides && indicators.length > 0) {
                const updateCarousel = () => {
                    const offset = -currentIndex * 100;
                    slides.style.transform = `translateX(${offset}%)`;
                    indicators.forEach((indicator, index) => {
                        if (index === currentIndex) {
                            indicator.classList.add('active');
                            indicator.style.backgroundColor = '#FF6B1F';
                        } else {
                            indicator.classList.remove('active');
                            indicator.style.backgroundColor = 'rgba(255, 255, 255, 0.7)';
                        }
                    });
                };
                const nextSlide = () => {
                    currentIndex = (currentIndex + 1) % totalSlides;
                    updateCarousel();
                };
                const prevSlide = () => {
                    currentIndex = (currentIndex - 1 + totalSlides) % totalSlides;
                    updateCarousel();
                };
                // --- FIX APPLIED: Corrected function call for 'next-slide' button
                document.getElementById('next-slide').addEventListener('click', nextSlide);
                document.getElementById('prev-slide').addEventListener('click', prevSlide);
                indicators.forEach((indicator, index) => {
                    indicator.addEventListener('click', () => {
                        currentIndex = index;
                        updateCarousel();
                    });
                });
                setInterval(nextSlide, 5000);
                updateCarousel();
            }

            const profileButton = document.getElementById('profile-button');
            const profileMenu = document.getElementById('profile-menu');

            // --- Profile Dropdown Logic ---
            if (profileButton && profileMenu) {
                profileButton.addEventListener('click', (event) => {
                    profileMenu.classList.toggle('open');
                    event.stopPropagation();
                });
                window.addEventListener('click', (event) => {
                    if (!profileMenu.contains(event.target) && !profileButton.contains(event.target)) {
                        profileMenu.classList.remove('open');
                    }
                });
            }

            // --- AUTH TOGGLE LISTENER (Fixed Sign Out) ---
            document.getElementById('auth-toggle-btn').addEventListener('click', async (event) => {
                event.preventDefault();

                if (CURRENT_USER_ID !== 'not-authenticated-user-placeholder') {
                    try {
                        await signOut(auth); // The actual Firebase sign out call
                        window.location.href = 'login.html';
                    } catch (error) {
                        console.error("Error signing out:", error);
                        alert('Sign Out Failed', 'Could not sign out. Please check your connection.', 'error');
                    }
                } else {
                    window.location.href = 'login.html';
                }
            });

            // --- CART DRAWER EVENT LISTENERS ---
            document.getElementById('cart-button').addEventListener('click', toggleCartDrawer);
            document.getElementById('close-cart-btn').addEventListener('click', toggleCartDrawer);
            document.getElementById('cart-backdrop').addEventListener('click', toggleCartDrawer);

            selectAllCheckbox.addEventListener('change', (event) => {
                const checked = event.target.checked;
                cartItems.forEach(item => item.selected = checked);
                renderCart();
                saveCartToFirestore();
            });

            document.getElementById('checkout-button').addEventListener('click', openOrderReview);


            setLogLevel('debug');
            const productsRef = collection(db, 'artifacts', appId, 'public', 'data', 'products');
            const q = query(productsRef);

            onSnapshot(q, (querySnapshot) => {
                featuredProductsGrid.innerHTML = '';
                if (querySnapshot.empty) {
                    featuredProductsGrid.innerHTML =
                        '<p class="text-center text-text-muted col-span-full py-12">No products available.</p>';
                    return;
                }
                querySnapshot.forEach((doc) => {
                    const product = doc.data();
                    product.id = doc.id;
                    renderProductCard(product);
                });
            }, (error) => {
                console.error("Error fetching products:", error);
                featuredProductsGrid.innerHTML =
                    '<p class="text-center text-red-danger col-span-full py-12">Failed to load products. Check console for details.</p>';
            });
        });


        function alert(title, message, type = 'info') {
            let color = 'bg-primary-blue';
            if (type === 'success') color = 'bg-green-500';
            else if (type === 'error') color = 'bg-red-danger';

            const alertDiv = document.createElement('div');
            alertDiv.className =
                'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[100]';
            alertDiv.innerHTML = `
                <div class="bg-white rounded-lg shadow-2xl max-w-sm w-full mx-4 overflow-hidden transform transition-all scale-100 duration-300">
                    <div class=\"${color} text-white p-4 text-xl font-bold\">${title}</div>
                    <div class="p-6 text-text-dark">
                        <p>${message}</p>
                    </div>
                    <div class="p-4 border-t flex justify-end">
                        <button class="px-4 py-2 bg-primary-blue text-white rounded-lg hover:bg-blue-600 transition-colors" onclick="this.closest('.fixed').remove()">
                            OK
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(alertDiv);
        }
        window.alert = alert;
    </script>
</body>

</html>